// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionPlan {
  STARTER
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PAST_DUE
}

// ==========================================
// TENANT (UMKM) - CORE TABLE
// ==========================================

model Tenant {
  id          String       @id @default(cuid())
  slug        String       @unique
  name        String
  category    String
  description String?
  
  // Contact
  whatsapp    String
  email       String       @unique
  phone       String?
  address     String?
  
  // Branding
  logo        String?
  theme       Json?        // { primaryColor: "#hex" }
  
  // ==========================================
  // üöÄ LANDING PAGE BUILDER (v3.0)
  // ==========================================
  landingConfig Json?      // { enabled, template, sectionOrder, hero, about, products, testimonials, cta, contact }
  
  // ==========================================
  // SEO FIELDS
  // ==========================================
  metaTitle       String?   @db.VarChar(60)
  metaDescription String?   @db.VarChar(160)
  socialLinks     Json?     // { instagram, facebook, tiktok, youtube, twitter }
  
  // ==========================================
  // üåê CUSTOM DOMAIN SETTINGS
  // ==========================================
  customDomain          String?   @unique
  customDomainVerified  Boolean   @default(false)
  customDomainToken     String?   @unique
  
  sslStatus             String?   @default("pending")
  sslIssuedAt           DateTime?
  
  dnsRecords            Json?
  
  customDomainAddedAt    DateTime?
  customDomainVerifiedAt DateTime?
  customDomainRemovedAt  DateTime?
  
  // ==========================================
  // PAYMENT SETTINGS (For Display Only)
  // ==========================================
  currency        String    @default("IDR")
  taxRate         Float     @default(0)
  paymentMethods  Json?     // Bank accounts, e-wallets for display
  
  // ==========================================
  // SHIPPING SETTINGS (For Display Only)
  // ==========================================
  freeShippingThreshold  Float?
  defaultShippingCost    Float     @default(0)
  shippingMethods        Json?     // Courier options for display
  
  // ==========================================
  // LEGACY STORE FIELDS (Backward Compatibility)
  // TODO: Remove in v2.0 after all tenants migrated to landingConfig
  // ==========================================
  heroTitle           String?   @db.VarChar(200)
  heroSubtitle        String?   @db.VarChar(300)
  heroCtaText         String?   @db.VarChar(50)
  heroCtaLink         String?   @db.VarChar(500)
  heroBackgroundImage String?

  aboutTitle          String?   @db.VarChar(200)
  aboutSubtitle       String?   @db.VarChar(300)
  aboutContent        String?   @db.Text
  aboutImage          String?
  aboutFeatures       Json?

  testimonialsTitle    String?   @db.VarChar(200)
  testimonialsSubtitle String?   @db.VarChar(300)
  testimonials         Json?

  contactTitle         String?   @db.VarChar(200)
  contactSubtitle      String?   @db.VarChar(300)
  contactMapUrl        String?
  contactShowMap       Boolean   @default(false)
  contactShowForm      Boolean   @default(true)

  ctaTitle             String?   @db.VarChar(200)
  ctaSubtitle          String?   @db.VarChar(300)
  ctaButtonText        String?   @db.VarChar(50)
  ctaButtonLink        String?   @db.VarChar(500)
  ctaButtonStyle       String?   @db.VarChar(20) @default("primary")

  // Auth
  password      String
  status        TenantStatus @default(ACTIVE)
  
  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  products              Product[]
  subscription          Subscription?
  subscriptionPayments  SubscriptionPayment[]
  domainLogs            DomainLog[]

  @@index([slug])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@index([customDomain])
  @@index([customDomainVerified])
}

// ==========================================
// PRODUCT (For Products Section in Landing Page)
// ==========================================

model Product {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name         String
  slug         String?
  description  String?   @db.Text
  category     String?
  sku          String?
  
  // Pricing
  price        Float
  comparePrice Float?
  
  // Stock (Simple - for display only)
  stock        Int?
  trackStock   Boolean   @default(false)
  unit         String?
  
  // Media
  images       String[]
  
  // Status
  isActive     Boolean   @default(true)
  isFeatured   Boolean   @default(false)
  
  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([tenantId, sku])
  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
  @@index([tenantId, category])
  @@index([tenantId, isFeatured])
  @@index([tenantId, slug])
  @@index([tenantId, createdAt])
}

// ==========================================
// SUBSCRIPTION (Plan UMKM)
// ==========================================

model Subscription {
  id                 String             @id @default(cuid())

  tenantId           String             @unique
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  plan               SubscriptionPlan   @default(STARTER)
  status             SubscriptionStatus @default(ACTIVE)

  currentPeriodStart DateTime?          @map("current_period_start")
  currentPeriodEnd   DateTime?          @map("current_period_end")

  isTrial            Boolean            @default(false) @map("is_trial")
  trialEndsAt        DateTime?          @map("trial_ends_at")

  priceAmount        Float              @default(0) @map("price_amount")
  currency           String             @default("IDR")

  cancelledAt        DateTime?          @map("cancelled_at")
  cancelReason       String?            @map("cancel_reason")

  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  payments           SubscriptionPayment[]

  @@map("subscriptions")
  @@index([tenantId])
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
}

// ==========================================
// SUBSCRIPTION PAYMENT (Midtrans Integration)
// ==========================================

model SubscriptionPayment {
  id                    String       @id @default(cuid())

  subscriptionId        String       @map("subscription_id")
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  tenantId              String       @map("tenant_id")
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  midtransOrderId       String       @unique @map("midtrans_order_id")
  midtransTransactionId String?      @unique @map("midtrans_transaction_id")
  snapToken             String?      @map("snap_token")
  snapRedirectUrl       String?      @map("snap_redirect_url")

  amount                Float
  currency              String       @default("IDR")

  paymentType           String?      @map("payment_type")
  bank                  String?
  vaNumber              String?      @map("va_number")

  paymentStatus         String       @default("pending") @map("payment_status")
  fraudStatus           String?      @map("fraud_status")

  periodStart           DateTime     @map("period_start")
  periodEnd             DateTime     @map("period_end")

  rawNotification       Json?        @map("raw_notification")
  metadata              Json?

  paidAt                DateTime?    @map("paid_at")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  @@map("subscription_payments")
  @@index([tenantId])
  @@index([subscriptionId])
  @@index([midtransOrderId])
  @@index([paymentStatus])
  @@index([tenantId, createdAt])
}

// ==========================================
// DOMAIN LOG (Audit Trail)
// ==========================================

model DomainLog {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  action      String
  domain      String
  status      String?
  message     String?  @db.Text
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
  @@map("domain_logs")
}