// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  FAILED
}

// ==========================================
// SUBSCRIPTION ENUMS
// ==========================================

enum SubscriptionPlan {
  STARTER
  BUSINESS
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PAST_DUE
}

// ==========================================
// WHATSAPP ENUMS (CLEANED)
// ==========================================

enum WhatsAppSessionStatus {
  QR_PENDING
  CONNECTING
  CONNECTED
  DISCONNECTED
}

enum AutoReplyTriggerType {
  WELCOME
  KEYWORD
  TIME_BASED
  ORDER_STATUS
  PAYMENT_STATUS
}

enum KeywordMatchType {
  EXACT
  CONTAINS
  STARTS_WITH
}

// ==========================================
// TENANT (UMKM)
// ==========================================

model Tenant {
  id            String       @id @default(cuid())
  slug          String       @unique
  name          String
  category      String
  description   String?
  whatsapp      String
  email         String       @unique
  phone         String?
  address       String?
  logo          String?
  theme         Json?
  landingConfig Json?
  
  // ==========================================
  // SEO FIELDS
  // ==========================================
  metaTitle       String?   @db.VarChar(60)
  metaDescription String?   @db.VarChar(160)
  socialLinks     Json?
  
  // ==========================================
  // PAYMENT SETTINGS
  // ==========================================
  currency        String    @default("IDR")
  taxRate         Float     @default(0)
  paymentMethods  Json?
  
  // ==========================================
  // SHIPPING SETTINGS
  // ==========================================
  freeShippingThreshold  Float?
  defaultShippingCost    Float     @default(0)
  shippingMethods        Json?
  
  // ==========================================
  // STORE INFORMATION - HERO SECTION
  // ==========================================
  heroTitle           String?   @db.VarChar(200)
  heroSubtitle        String?   @db.VarChar(300)
  heroCtaText         String?   @db.VarChar(50)
  heroCtaLink         String?   @db.VarChar(500)
  heroBackgroundImage String?

  // ==========================================
  // STORE INFORMATION - ABOUT SECTION
  // ==========================================
  aboutTitle          String?   @db.VarChar(200)
  aboutSubtitle       String?   @db.VarChar(300)
  aboutContent        String?   @db.Text
  aboutImage          String?
  aboutFeatures       Json?

  // ==========================================
  // STORE INFORMATION - TESTIMONIALS SECTION
  // ==========================================
  testimonialsTitle    String?   @db.VarChar(200)
  testimonialsSubtitle String?   @db.VarChar(300)
  testimonials         Json?

  // ==========================================
  // STORE INFORMATION - CONTACT SECTION
  // ==========================================
  contactTitle         String?   @db.VarChar(200)
  contactSubtitle      String?   @db.VarChar(300)
  contactMapUrl        String?
  contactShowMap       Boolean   @default(false)
  contactShowForm      Boolean   @default(true)

  // ==========================================
  // STORE INFORMATION - CTA SECTION
  // ==========================================
  ctaTitle             String?   @db.VarChar(200)
  ctaSubtitle          String?   @db.VarChar(300)
  ctaButtonText        String?   @db.VarChar(50)
  ctaButtonLink        String?   @db.VarChar(500)
  ctaButtonStyle       String?   @db.VarChar(20) @default("primary")

  password      String
  status        TenantStatus @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  products      Product[]
  customers     Customer[]
  orders        Order[]
  feeds         Feed[]
  feedLikes     FeedLike[]
  feedComments  FeedComment[]
  feedViews     FeedView[]
  feedBookmarks FeedBookmark[]

  // Subscription
  subscription          Subscription?
  subscriptionPayments  SubscriptionPayment[]

  // WhatsApp Auto-Reply System (CLEANED)
  whatsappSession  WhatsAppSession?
  contacts         Contact[]
  autoReplyRules   AutoReplyRule[]

  @@index([slug])
  @@index([category])
  @@index([status])
}

// ==========================================
// PRODUCT / SERVICE
// ==========================================

model Product {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name         String
  description  String?
  category     String?
  sku          String?
  
  // Pricing
  price        Float
  comparePrice Float?
  costPrice    Float?
  
  // Stock
  stock        Int?
  minStock     Int?
  trackStock   Boolean  @default(false)
  unit         String?
  
  // Media
  images       String[]
  
  // Category-specific data
  metadata     Json?
  
  // Status
  isActive     Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  
  // SEO SLUG
  slug         String?
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  orderItems   OrderItem[]
  feeds        Feed[]

  @@unique([tenantId, sku])
  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, category])
  @@index([tenantId, isFeatured])
  @@index([tenantId, slug])
}

// ==========================================
// CUSTOMER
// ==========================================

model Customer {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name        String
  phone       String
  email       String?
  address     String?
  
  // Category-specific data
  metadata    Json?
  
  // Stats
  totalOrders Int      @default(0)
  totalSpent  Float    @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders      Order[]
  
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, name])
}

// ==========================================
// ORDER / TRANSACTION
// ==========================================

model Order {
  id            String        @id @default(cuid())
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Order Info
  orderNumber   String
  
  // Items
  items         OrderItem[]
  
  // Pricing
  subtotal      Float
  discount      Float         @default(0)
  tax           Float         @default(0)
  total         Float
  
  // Payment
  paymentMethod String?
  paymentStatus PaymentStatus @default(PENDING)
  paidAmount    Float         @default(0)
  
  // Status
  status        OrderStatus   @default(PENDING)
  
  // Guest Order
  customerName  String?
  customerPhone String?
  
  // Notes
  notes         String?
  
  // Category-specific data
  metadata      Json?
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  
  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, paymentStatus])
  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([tenantId, paymentStatus, createdAt])
}

// ==========================================
// ORDER ITEM
// ==========================================

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  // Store info (in case product deleted/changed)
  name      String
  price     Float
  qty       Int
  subtotal  Float
  
  // Additional
  notes     String?
  metadata  Json?
  
  @@index([orderId])
  @@index([productId])
}

// ==========================================
// WHATSAPP SESSION
// ==========================================

model WhatsAppSession {
  id                   String                @id @default(cuid())

  // Foreign Keys
  tenantId             String                @unique
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // WhatsApp Connection
  phoneNumber          String                @unique
  qrCode               String?               @db.Text

  // Status
  status               WhatsAppSessionStatus @default(DISCONNECTED)
  connectionState      Json?

  // Session Data
  authStatePath        String?

  // Metadata
  lastConnectedAt      DateTime?
  lastDisconnectedAt   DateTime?
  lastBackupAt         DateTime?

  // Timestamps
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([status])
  @@index([tenantId])
}

// ==========================================
// CONTACT (For Auto-Reply Tracking)
// ==========================================

model Contact {
  id                   String          @id @default(cuid())

  // Foreign Keys
  tenantId             String
  tenant               Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // WhatsApp Info
  phone                String
  waId                 String?
  name                 String?
  avatarUrl            String?         @db.Text

  // Interaction Stats
  totalConversations   Int             @default(0)
  firstContactAt       DateTime?
  lastContactAt        DateTime?

  // Timestamps
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
}

// ==========================================
// AUTO REPLY RULE
// ==========================================

model AutoReplyRule {
  id                String                @id @default(cuid())

  // Foreign Keys
  tenantId          String
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Rule Info
  name              String
  description       String?               @db.Text

  // Trigger Type
  triggerType       AutoReplyTriggerType

  // Keywords Array
  keywords          String[]
  matchType         KeywordMatchType      @default(CONTAINS)
  caseSensitive     Boolean               @default(false)

  // Time-based (for outside hours)
  workingHours      Json?

  // Response
  responseMessage   String                @db.Text

  // Behavior
  priority          Int                   @default(50)
  delaySeconds      Int                   @default(2)

  // Tracking
  totalTriggered    Int                   @default(0)
  lastTriggeredAt   DateTime?

  // Status
  isActive          Boolean               @default(true)

  // Timestamps
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  logs              AutoReplyLog[]

  // Indexes
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, priority(sort: Desc)])

  // Unique Constraint
  @@unique([tenantId, triggerType, keywords])
}

// ==========================================
// AUTO REPLY LOG (NUCLEAR CLEAN VERSION)
// ==========================================

model AutoReplyLog {
  id                   String          @id @default(cuid())

  // Foreign Keys
  ruleId               String
  rule                 AutoReplyRule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  // Trigger Info
  triggeredByMessage   String?         @db.Text
  responseSent         String?         @db.Text
  matchedKeyword       String?

  // Timestamp
  triggeredAt          DateTime        @default(now())

  @@index([ruleId, triggeredAt(sort: Desc)])
}

// ==========================================
// SUBSCRIPTION (Plan UMKM)
// ==========================================

model Subscription {
  id                 String             @id @default(cuid())

  tenantId           String             @unique
  tenant             Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  plan               SubscriptionPlan   @default(STARTER)
  status             SubscriptionStatus @default(ACTIVE)

  currentPeriodStart DateTime?          @map("current_period_start")
  currentPeriodEnd   DateTime?          @map("current_period_end")

  isTrial            Boolean            @default(false) @map("is_trial")
  trialEndsAt        DateTime?          @map("trial_ends_at")

  priceAmount        Float              @default(0) @map("price_amount")
  currency           String             @default("IDR")

  cancelledAt        DateTime?          @map("cancelled_at")
  cancelReason       String?            @map("cancel_reason")

  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  payments           SubscriptionPayment[]

  @@map("subscriptions")
  @@index([tenantId])
  @@index([status])
  @@index([plan])
  @@index([currentPeriodEnd])
}

// ==========================================
// SUBSCRIPTION PAYMENT
// ==========================================

model SubscriptionPayment {
  id                    String       @id @default(cuid())

  subscriptionId        String       @map("subscription_id")
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  tenantId              String       @map("tenant_id")
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  midtransOrderId       String       @unique @map("midtrans_order_id")
  midtransTransactionId String?      @unique @map("midtrans_transaction_id")
  snapToken             String?      @map("snap_token")
  snapRedirectUrl       String?      @map("snap_redirect_url")

  amount                Float
  currency              String       @default("IDR")

  paymentType           String?      @map("payment_type")
  bank                  String?
  vaNumber              String?      @map("va_number")

  paymentStatus         String       @default("pending") @map("payment_status")
  fraudStatus           String?      @map("fraud_status")

  periodStart           DateTime     @map("period_start")
  periodEnd             DateTime     @map("period_end")

  rawNotification       Json?        @map("raw_notification")
  metadata              Json?

  paidAt                DateTime?    @map("paid_at")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  @@map("subscription_payments")
  @@index([tenantId])
  @@index([subscriptionId])
  @@index([midtransOrderId])
  @@index([paymentStatus])
  @@index([tenantId, createdAt])
}

// ==========================================
// FEED (Product Discovery Feed)
// ==========================================

model Feed {
  id            String   @id @default(cuid())

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  caption       String?  @db.Text

  viewCount     Int      @default(0)
  likeCount     Int      @default(0)
  commentCount  Int      @default(0)
  bookmarkCount Int      @default(0)

  likes         FeedLike[]
  comments      FeedComment[]
  views         FeedView[]
  bookmarks     FeedBookmark[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, productId])
  @@index([createdAt(sort: Desc)])
  @@index([tenantId])
}

model FeedLike {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])
  @@index([feedId])
}

model FeedComment {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  content   String   @db.Text

  parentId  String?
  parent    FeedComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   FeedComment[] @relation("CommentReplies")

  createdAt DateTime @default(now())

  @@index([feedId, createdAt(sort: Desc)])
  @@index([parentId])
}

model FeedView {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])
  @@index([feedId])
}

model FeedBookmark {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])
  @@index([feedId])
  @@index([tenantId])
}