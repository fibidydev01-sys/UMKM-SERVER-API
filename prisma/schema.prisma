// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  FAILED
}

// ==========================================
// TENANT (UMKM)
// ==========================================

model Tenant {
  id            String       @id @default(cuid())
  slug          String       @unique
  name          String
  category      String
  description   String?
  whatsapp      String
  email         String       @unique
  phone         String?
  address       String?
  logo          String?
  theme         Json?
  landingConfig Json?
  
  // ==========================================
  // SEO FIELDS
  // ==========================================
  metaTitle       String?   @db.VarChar(60)
  metaDescription String?   @db.VarChar(160)
  socialLinks     Json?     // { instagram, facebook, tiktok, youtube, twitter }
  
  // ==========================================
  // PAYMENT SETTINGS (NEW)
  // ==========================================
  currency        String    @default("IDR")
  taxRate         Float     @default(0)        // Percentage, e.g., 11 for 11%
  paymentMethods  Json?     // See PaymentMethods type below
  
  // ==========================================
  // SHIPPING SETTINGS (NEW)
  // ==========================================
  freeShippingThreshold  Float?                // Minimum order for free shipping
  defaultShippingCost    Float     @default(0) // Default shipping cost
  shippingMethods        Json?                 // See ShippingMethods type below
  
  // ==========================================
  // STORE INFORMATION - HERO SECTION
  // ==========================================
  heroTitle           String?   @db.VarChar(200)
  heroSubtitle        String?   @db.VarChar(300)
  heroCtaText         String?   @db.VarChar(50)
  heroCtaLink         String?   @db.VarChar(500)
  heroBackgroundImage String?

  // ==========================================
  // STORE INFORMATION - ABOUT SECTION
  // ==========================================
  aboutTitle          String?   @db.VarChar(200)
  aboutSubtitle       String?   @db.VarChar(300)
  aboutContent        String?   @db.Text
  aboutImage          String?
  aboutFeatures       Json?     // [{ icon, title, description }]

  // ==========================================
  // STORE INFORMATION - TESTIMONIALS SECTION
  // ==========================================
  testimonialsTitle    String?   @db.VarChar(200)
  testimonialsSubtitle String?   @db.VarChar(300)
  testimonials         Json?     // [{ id, name, role, content, rating, avatar }]

  // ==========================================
  // STORE INFORMATION - CONTACT SECTION
  // ==========================================
  contactTitle         String?   @db.VarChar(200)
  contactSubtitle      String?   @db.VarChar(300)
  contactMapUrl        String?
  contactShowMap       Boolean   @default(false)
  contactShowForm      Boolean   @default(true)

  // ==========================================
  // STORE INFORMATION - CTA SECTION
  // ==========================================
  ctaTitle             String?   @db.VarChar(200)
  ctaSubtitle          String?   @db.VarChar(300)
  ctaButtonText        String?   @db.VarChar(50)
  ctaButtonLink        String?   @db.VarChar(500)
  ctaButtonStyle       String?   @db.VarChar(20) @default("primary")

  password      String
  status        TenantStatus @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  products      Product[]
  customers     Customer[]
  orders        Order[]
  feeds          Feed[]
  feedLikes      FeedLike[]
  feedComments   FeedComment[]
  feedViews      FeedView[]
  feedBookmarks  FeedBookmark[]

  // WhatsApp Chat System Relations
  whatsappSession  WhatsAppSession?
  conversations    Conversation[]
  contacts         Contact[]
  autoReplyRules   AutoReplyRule[]

  @@index([slug])
  @@index([category])
  @@index([status])
}

// ==========================================
// PRODUCT / SERVICE
// ==========================================

model Product {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name         String
  description  String?
  category     String?
  sku          String?
  
  // Pricing
  price        Float
  comparePrice Float?
  costPrice    Float?
  
  // Stock
  stock        Int?
  minStock     Int?
  trackStock   Boolean  @default(false)
  unit         String?
  
  // Media
  images       String[]
  
  // Category-specific data
  metadata     Json?
  
  // Status
  isActive     Boolean  @default(true)
  isFeatured   Boolean  @default(false)
  
  // ==========================================
  // SEO SLUG (Already exists - just adding constraints)
  // ==========================================
  slug         String?
  
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  orderItems   OrderItem[]
  feeds        Feed[]

  @@unique([tenantId, sku])
  @@unique([tenantId, slug])  // NEW: Ensure unique slug per tenant
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, category])
  @@index([tenantId, isFeatured])
  @@index([tenantId, slug])   // NEW: Index for slug lookups
}

// ==========================================
// CUSTOMER
// ==========================================

model Customer {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  // Basic Info
  name        String
  phone       String
  email       String?
  address     String?
  
  // Category-specific data
  metadata    Json?
  
  // Stats
  totalOrders Int      @default(0)
  totalSpent  Float    @default(0)
  
  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  orders      Order[]
  
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([tenantId, phone])
  @@index([tenantId, name])
}

// ==========================================
// ORDER / TRANSACTION
// ==========================================

model Order {
  id            String        @id @default(cuid())
  tenantId      String
  tenant        Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  customerId    String?
  customer      Customer?     @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  // Order Info
  orderNumber   String
  
  // Items
  items         OrderItem[]
  
  // Pricing
  subtotal      Float
  discount      Float         @default(0)
  tax           Float         @default(0)
  total         Float
  
  // Payment
  paymentMethod String?
  paymentStatus PaymentStatus @default(PENDING)
  paidAmount    Float         @default(0)
  
  // Status
  status        OrderStatus   @default(PENDING)
  
  // Guest Order
  customerName  String?
  customerPhone String?
  
  // Notes
  notes         String?
  
  // Category-specific data
  metadata      Json?
  
  // Timestamps
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  
  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, paymentStatus])
  @@index([tenantId, createdAt])
  @@index([customerId])
  @@index([tenantId, paymentStatus, createdAt])
}

// ==========================================
// ORDER ITEM
// ==========================================

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  // Store info (in case product deleted/changed)
  name      String
  price     Float
  qty       Int
  subtotal  Float
  
  // Additional
  notes     String?
  metadata  Json?
  
  @@index([orderId])
  @@index([productId])
}

// ==========================================
// WHATSAPP CHAT SYSTEM
// ==========================================

enum WhatsAppSessionStatus {
  QR_PENDING
  CONNECTING
  CONNECTED
  DISCONNECTED
}

enum ConversationStatus {
  ACTIVE
  RESOLVED
  CLOSED
}

enum MessageSenderType {
  CUSTOMER
  OWNER
  AUTO_REPLY
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum AutoReplyTriggerType {
  WELCOME
  KEYWORD
  TIME_BASED
  ORDER_STATUS
  PAYMENT_STATUS
}

enum KeywordMatchType {
  EXACT
  CONTAINS
  STARTS_WITH
}

// ==========================================
// WHATSAPP SESSION
// ==========================================

model WhatsAppSession {
  id                   String                @id @default(cuid())

  // Foreign Keys
  tenantId             String                @unique
  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // WhatsApp Connection
  phoneNumber          String                @unique
  qrCode               String?               @db.Text

  // Status
  status               WhatsAppSessionStatus @default(DISCONNECTED)
  connectionState      Json?

  // Session Data
  authStatePath        String?

  // Metadata
  lastConnectedAt      DateTime?
  lastDisconnectedAt   DateTime?
  lastBackupAt         DateTime?

  // Timestamps
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt

  @@index([status])
  @@index([tenantId])
}

// ==========================================
// CONVERSATION
// ==========================================

model Conversation {
  id                  String              @id @default(cuid())

  // Foreign Keys
  tenantId            String
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId           String?
  contact             Contact?            @relation(fields: [contactId], references: [id], onDelete: SetNull)

  // Customer Info
  customerPhone       String
  customerName        String?
  customerAvatarUrl   String?             @db.Text

  // State
  status              ConversationStatus  @default(ACTIVE)

  // Counters
  unreadCount         Int                 @default(0)
  totalMessages       Int                 @default(0)

  // Last Message (for sorting)
  lastMessageAt       DateTime            @default(now())
  lastMessageContent  String?             @db.Text
  lastMessageFrom     String?

  // Timestamps
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  // Relations
  messages            Message[]
  autoReplyLogs       AutoReplyLog[]

  @@unique([tenantId, customerPhone])
  @@index([tenantId])
  @@index([tenantId, lastMessageAt(sort: Desc)])
  @@index([tenantId, unreadCount])
}

// ==========================================
// MESSAGE
// ==========================================

model Message {
  id                String            @id @default(cuid())

  // Foreign Keys
  conversationId    String
  conversation      Conversation      @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // WhatsApp Message ID
  waMessageId       String?           @unique

  // Sender Info
  senderType        MessageSenderType
  senderId          String?
  senderName        String?

  // Message Content
  messageType       MessageType       @default(TEXT)
  content           String?           @db.Text
  mediaUrl          String?           @db.Text
  mediaMimeType     String?

  // Quoted Message (reply)
  quotedMessageId   String?
  quotedMessage     Message?          @relation("MessageReplies", fields: [quotedMessageId], references: [id], onDelete: SetNull)
  replies           Message[]         @relation("MessageReplies")

  // Delivery Status
  status            MessageStatus     @default(PENDING)

  // Timestamps
  sentAt            DateTime          @default(now())
  deliveredAt       DateTime?
  readAt            DateTime?
  createdAt         DateTime          @default(now())

  // Relations
  autoReplyLogs     AutoReplyLog[]

  @@index([conversationId, sentAt(sort: Desc)])
  @@index([waMessageId])
}

// ==========================================
// CONTACT
// ==========================================

model Contact {
  id                   String          @id @default(cuid())

  // Foreign Keys
  tenantId             String
  tenant               Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // WhatsApp Info
  phone                String
  waId                 String?
  name                 String?
  avatarUrl            String?         @db.Text

  // Interaction Stats
  totalConversations   Int             @default(0)
  firstContactAt       DateTime?
  lastContactAt        DateTime?

  // Timestamps
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relations
  conversations        Conversation[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
}

// ==========================================
// AUTO REPLY RULE
// ==========================================

model AutoReplyRule {
  id                String                @id @default(cuid())

  // Foreign Keys
  tenantId          String
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Rule Info
  name              String
  description       String?               @db.Text

  // Trigger Type
  triggerType       AutoReplyTriggerType

  // Keywords Array (used for multiple trigger types)
  // - KEYWORD: ["harga", "promo", "order"] - multiple keywords to match
  // - ORDER_STATUS: ["PENDING"] or ["PROCESSING"] - single status value
  // - PAYMENT_STATUS: ["PAID"] or ["FAILED"] - single status value
  keywords          String[]
  matchType         KeywordMatchType      @default(CONTAINS)
  caseSensitive     Boolean               @default(false)

  // Time-based (for outside hours)
  workingHours      Json?

  // Response
  responseMessage   String                @db.Text

  // Behavior
  priority          Int                   @default(50)
  delaySeconds      Int                   @default(2)

  // Tracking
  totalTriggered    Int                   @default(0)
  lastTriggeredAt   DateTime?

  // Status
  isActive          Boolean               @default(true)

  // Timestamps
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  logs              AutoReplyLog[]

  // Indexes
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, priority(sort: Desc)])

  // Unique Constraint: Prevent duplicate rules per status per tenant
  // Ensures: 1 tenant can only create 1 rule per ORDER_STATUS/PAYMENT_STATUS
  @@unique([tenantId, triggerType, keywords])
}

// ==========================================
// AUTO REPLY LOG
// ==========================================

model AutoReplyLog {
  id                   String          @id @default(cuid())

  // Foreign Keys
  ruleId               String
  rule                 AutoReplyRule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  conversationId       String
  conversation         Conversation    @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  messageId            String?
  message              Message?        @relation(fields: [messageId], references: [id], onDelete: SetNull)

  // Trigger Info
  triggeredByMessage   String?         @db.Text
  responseSent         String?         @db.Text
  matchedKeyword       String?

  // Timestamp
  triggeredAt          DateTime        @default(now())

  @@index([ruleId, triggeredAt(sort: Desc)])
  @@index([conversationId])
}

// ==========================================
// FEED (Product Discovery Feed)
// ==========================================

model Feed {
  id            String   @id @default(cuid())

  // Relations
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productId     String
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Content
  caption       String?  @db.Text

  // Engagement Metrics (counters)
  viewCount     Int      @default(0)
  likeCount     Int      @default(0)
  commentCount  Int      @default(0)

  // Engagement counter
  bookmarkCount Int      @default(0)

  // Interaction Relations
  likes         FeedLike[]
  comments      FeedComment[]
  views         FeedView[]
  bookmarks     FeedBookmark[]

  // Timestamps
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Constraints
  @@unique([tenantId, productId])  // 1 tenant hanya bisa post 1 produk sekali
  @@index([createdAt(sort: Desc)]) // Chronological query
  @@index([tenantId])
}

model FeedLike {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])  // 1 tenant hanya bisa like 1x per feed
  @@index([feedId])
}

model FeedComment {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  content   String   @db.Text

  // Nested reply support
  parentId  String?
  parent    FeedComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   FeedComment[] @relation("CommentReplies")

  createdAt DateTime @default(now())

  @@index([feedId, createdAt(sort: Desc)])  // Comments chronological per feed
  @@index([parentId])
}

// Track unique views per user per feed
model FeedView {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])  // 1 user hanya dihitung 1x view
  @@index([feedId])
}

// Bookmark/Save feed post
model FeedBookmark {
  id        String   @id @default(cuid())

  feedId    String
  feed      Feed     @relation(fields: [feedId], references: [id], onDelete: Cascade)

  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([feedId, tenantId])  // 1 user hanya bisa bookmark 1x per feed
  @@index([feedId])
  @@index([tenantId])
}